<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Document</title>
	</head>

	<body>

	</body>

</html>

<!DOCTYPE html>
<html>

	<head>
		<title>Pasuuna player demo</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

		<style>
			#playlist li:hover {
				cursor: pointer;
				color: green;
			}
		</style>
	</head>

	<body class="container">

		<div class="row">
			<div class="col">
				<h1>Pasuuna Player Standalone Demo</h1>
			</div>
		</div>

		<div class="row">

			<div class="col-4">
				<div class="card" id="player">
					<div class="card-body">
						<h5 class="card-title">Player</h5>

						<button id="play" disabled>Play</button> <span id="songname">Select a song...</span>

						<div class="range">
							Volume:
							<input id="volume" type="range" min="0" max="100" value="70">
						</div>
						<div class="range wide">
							Progress:
							<input id="progress" type="range" min="0" max="100" value="0">
						</div>
					</div>
				</div>
			</div>

			<div class="col-8">
				<div class="card">
					<div class="card-body">
						<h5 class="card-title">Playlist</h5>
						<ul id="playlist">
							<li onclick="play('https://api.modarchive.org/downloads.php?moduleid=57232#silkworm.mod')">
								Silkworm (MOD - SoundTracker)</li>
							<li
								onclick="play('https://api.modarchive.org/downloads.php?moduleid=57925#space_debris.mod')">
								Space Debris (MOD - ProTracker)</li>
							<li onclick="play('https://api.modarchive.org/downloads.php?moduleid=35280#DEADLOCK.XM')">
								Deadlock (XM - FastTracker)</li>
						</ul>
						<footer>
							<p>Songs downloaded from The Mod Archive. Used under their <a
									href="https://modarchive.org/index.php?terms-upload">license</a> for demo
								purposes.
							</p>
						</footer>

					</div>
				</div>
			</div>

		</div>


		<script src="pasuunaplayer.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const playButton = document.getElementById("play");
				const progressBar = document.getElementById("progress");
				const volumeBar = document.getElementById("volume");
				const songName = document.getElementById("songname");

				const tracker = new PasuunaPlayer.Tracker();
				tracker.init();

				if (!tracker.audio.context) {
					songName.innerHTML = "Your browser does not support WebAudio.";
				} else {

					var startTime;
					var wasPlaying;
					var patternLength;
					var songLength;

					tracker.events.on(PasuunaPlayer.EVENT.songLoaded, (song) => {
						console.log(song);
						playButton.disabled = false;
						songName.innerHTML = song.title;

						// We could loop over all the patterns to get the real length, but a rough estimate is good enough.
						patternLength = song.patterns[song.patternTable[0]].length;
						songLength = song.length * patternLength;

					});

					playItem = function (url) {
						playButton.disabled = true;
						stopPlay();
						songName.innerHTML = "Loading ...";
						tracker.load(url);
					};

					// setup UI

					playButton.onclick = function () {
						togglePlay();
					};

					// setup progress bar to seek into the song
					progressBar.oninput = function () {
						wasPlaying = wasPlaying || tracker.isPlaying;
						stopPlay();
					};

					progressBar.onchange = function () {
						// align to start of pattern
						var songPos = Math.floor((songLength * progressBar.value / 100) / patternLength);
						tracker.setCurrentSongPosition(songPos);
						if (wasPlaying) togglePlay();
						wasPlaying = false;
					};

					// setup progress bar to seek into the song
					volumeBar.oninput = volumeBar.onchange = function () {
						tracker.audio.masterVolume.gain.cancelScheduledValues(0);
						tracker.audio.masterVolume.gain.setValueAtTime(volumeBar.value / 100, 0);
					};

					// setup simple timer
					// this has nothing to do with audio playback, it's only used to update the UI once in a while;
					requestAnimationFrame(function loop() {
						if (startTime) {
							if (tracker.isPlaying) {
								var time = new Date().getTime() - startTime;
								var state = tracker.getStateAtTime(time);
								if (state) {
									var currentPos = state.songPos * patternLength + state.patternPos;
									var percentage = currentPos * 100 / songLength;
									progressBar.value = percentage;
								}
							}
						}
						requestAnimationFrame(loop);
					});

				}

				function togglePlay() {
					tracker.togglePlay();
					if (tracker.isPlaying) {
						startTime = new Date().getTime();
						playButton.innerHTML = "Pause";
					} else {
						playButton.innerHTML = "Play";
					}
				}

				function stopPlay() {
					tracker.stop();
					playButton.innerHTML = "Play";
				}
			});

			function play(url) {
				if (playItem) playItem(url);
			}

		</script>
	</body>

</html>